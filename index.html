<script>
    /* --- VARI츼VEIS GLOBAIS --- */
    let cidadesValidas = []; // Lista para travar cidades erradas

    /* --- 1. GERA칂츾O ANTECIPADA DE ID --- */
    // Gera o ID assim que abre o site
    const randomID = Math.floor(1000 + Math.random() * 9000);
    const meuID = "LMP-" + randomID;
    
    // 1. Preenche o campo oculto para ir no e-mail do Netlify
    document.getElementById('idLoomperInput').value = meuID;
    
    // 2. Salva no navegador para mostrar na pr칩xima tela
    localStorage.setItem('meuIdLoomper', meuID);

    /* --- 2. L칍GICA DAS ABAS (PERFIS) --- */
    function openTab(evt, tabName) {
        var i, tabContent, tabBtn;
        tabContent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabContent.length; i++) {
            tabContent[i].style.display = "none";
            tabContent[i].classList.remove("active");
        }
        tabBtn = document.getElementsByClassName("tab-btn");
        for (i = 0; i < tabBtn.length; i++) {
            tabBtn[i].className = tabBtn[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        setTimeout(() => document.getElementById(tabName).classList.add("active"), 10);
        evt.currentTarget.className += " active";
    }

    /* --- 3. TIMELINE DIN츽MICA --- */
    const stepsData = {
        1: "<h4>1. Cadastre-se</h4><p>Preencha seus dados e escolha seu perfil. 칄 r치pido e 100% gratuito para profissionais.</p>",
        2: "<h4>2. Valida칞칚o</h4><p>Nossa equipe valida suas informa칞칫es para garantir a seguran칞a da comunidade.</p>",
        3: "<h4>3. Receba Ofertas</h4><p>Conecte-se com oportunidades reais ou profissionais qualificados na sua regi칚o.</p>",
        4: "<h4>4. Opera칞칚o Segura</h4><p>Combine detalhes via chat integrado e realize o servi칞o com monitoramento.</p>",
        5: "<h4>5. Avalia칞칚o</h4><p>Finalize o servi칞o e avalie. Construa sua reputa칞칚o no ecossistema Loomper.</p>"
    };
    function setStep(stepNum) {
        document.getElementById('step-content').innerHTML = stepsData[stepNum];
        let dots = document.getElementsByClassName('step-dot');
        for(let d of dots) d.classList.remove('active');
        dots[stepNum-1].classList.add('active');
    }
    setStep(1);

    /* --- 4. ACCORDION --- */
    const details = document.querySelectorAll("details");
    details.forEach((targetDetail) => {
        targetDetail.addEventListener("click", () => {
            details.forEach((detail) => {
                if (detail !== targetDetail) {
                    detail.removeAttribute("open");
                }
            });
        });
    });

    /* --- 5. FORMUL츼RIO E VALIDA칂칏ES --- */
    // a) Detectar Convite na URL
    const urlParams = new URLSearchParams(window.location.search);
    const conviteCode = urlParams.get('convite');
    if(conviteCode) {
        document.getElementById('codigoIndicacao').value = conviteCode;
    }

    // b) Mudar Bot칚o de Acordo com Perfil
    function updateFormCTA() {
        const perfil = document.getElementById('perfilSelect').value;
        const btn = document.getElementById('submitBtn');
        const perfilEmpresa = ['Montadora', 'Seguradora', 'Governo/칍rg칚o P칰blico', 'Investidor'];
        if (perfilEmpresa.includes(perfil)) {
            btn.textContent = "SOLICITAR DEMONSTRA칂츾O";
        } else {
            btn.textContent = "QUERO SER PIONEIRO";
        }
    }

    function selectRole(role) {
        const select = document.getElementById('perfilSelect');
        select.value = role;
        updateFormCTA();
    }

    /* --- 6. API IBGE + TRAVA DE SEGURAN칂A --- */
    fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados?orderBy=nome')
        .then(res => res.json())
        .then(estados => {
            const selectUF = document.getElementById('estadoSelect');
            estados.forEach(uf => {
                const option = document.createElement('option');
                option.value = uf.sigla;
                option.textContent = uf.sigla;
                selectUF.appendChild(option);
            });
        });

    document.getElementById('estadoSelect').addEventListener('change', function() {
        const uf = this.value;
        const cidadeInput = document.getElementById('cidadeInput');
        cidadeInput.value = ""; // Limpa cidade ao trocar estado
        cidadesValidas = []; // Zera lista de valida칞칚o

        if(!uf) return;
        
        fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${uf}/municipios`)
            .then(res => res.json())
            .then(cidades => {
                const dataList = document.getElementById('cidadesList');
                dataList.innerHTML = '';
                cidades.forEach(cidade => {
                    // Adiciona na lista visual
                    const option = document.createElement('option');
                    option.value = cidade.nome;
                    dataList.appendChild(option);
                    // Adiciona na lista de seguran칞a (mem칩ria)
                    cidadesValidas.push(cidade.nome);
                });
            });
    });

    // 游뚿 INTERCEPTAR O ENVIO PARA VALIDAR CIDADE 游뚿
    document.getElementById('loomperForm').addEventListener('submit', function(e) {
        const cidadeDigitada = document.getElementById('cidadeInput').value;
        const estadoSelecionado = document.getElementById('estadoSelect').value;

        // Se tem estado selecionado, mas a cidade n칚o est치 na lista oficial do IBGE
        if (estadoSelecionado && !cidadesValidas.includes(cidadeDigitada)) {
            e.preventDefault(); // CANCELA O ENVIO
            alert(`Erro: A cidade "${cidadeDigitada}" n칚o pertence ao estado ${estadoSelecionado}. Por favor, selecione uma cidade v치lida da lista.`);
            document.getElementById('cidadeInput').focus();
            return false;
        }
        // Se passou, o Netlify envia normalmente
    });

    /* --- 7. EXTRAS --- */
    function copyPix(valor) {
        const pixKey = "contato@loomper.com.br"; 
        navigator.clipboard.writeText(pixKey).then(() => {
            const feedback = document.getElementById('pix-feedback');
            feedback.classList.remove('hidden');
            feedback.style.display = 'block';
            setTimeout(() => { feedback.style.display = 'none'; }, 6000);
        });
    }

    document.getElementById('whatsappInput').addEventListener('input', function (e) {
        let x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/);
        e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : '');
    });
</script>
